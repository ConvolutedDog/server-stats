name: Server Stats Update and Deploy

on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    # Intended trigger time: 00:00 Beijing Time (UTC+8).
    #   - Target UTC time: 16:00 (00:00 Beijing - 8 hours).
    # Note: cron syntax uses UTC time.
    - cron: "0 16 * * *"

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  update-stats:
    runs-on: ubuntu-latest

    outputs:
      stats_updated: ${{ steps.commit.outputs.stats_changed }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed for git operations later

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Add SSH key and configure known hosts
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "Host server-stats-host
            HostName ${{ secrets.SERVER_HOST }}
            User ${{ secrets.SSH_USERNAME }}
            Port ${{ secrets.SSH_PORT || '22' }}
            IdentityFile ~/.ssh/id_rsa" > ~/.ssh/config
          ssh-keyscan -p ${{ secrets.SSH_PORT || '22' }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Copy files to server
        run: |
          rsync -avz -e "ssh -p ${{ secrets.SSH_PORT || '22' }}" --delete \
            ./ ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_HOST }}:/tmp/server-stats/

      - name: Execute script on server
        run: |
          ssh -p ${{ secrets.SSH_PORT || '22' }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_HOST }} \
            "cd /tmp/server-stats/scripts && python3 count-user-login-minutes-every-day.py && \
             python3 transfer-csv-to-readme.py && python3 dashboard_html_gen.py"

      - name: Retrieve updated file
        run: |
          rsync -avz -e "ssh -p ${{ secrets.SSH_PORT || '22' }}" \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_HOST }}:/tmp/server-stats/ssh_login_minutes.csv \
            ./
          rsync -avz -e "ssh -p ${{ secrets.SSH_PORT || '22' }}" \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_HOST }}:/tmp/server-stats/README.md \
            ./
          ssh -p ${{ secrets.SSH_PORT || '22' }} \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_HOST }} \
            "rm -rf /tmp/server-stats"

      - name: Check for changes and commit
        id: commit
        env:
          GIT_PUSH_USER_NAME: ${{ secrets.GIT_PUSH_USER_NAME }}
          GIT_PUSH_USER_EMAIL: ${{ secrets.GIT_PUSH_USER_EMAIL }}
        run: |
          git config --global user.name "$GIT_PUSH_USER_NAME"
          git config --global user.email "$GIT_PUSH_USER_EMAIL"
          git add ./ssh_login_minutes.csv ./README.md ./dashboard

          # Check if there are changes to commit
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
            echo "stats_changed=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected, committing..."
            git commit -m "[Bot] Update login time at $(TZ=Asia/Shanghai date '+%H:%M UTC+8')"
            git push
            echo "stats_changed=true" >> $GITHUB_OUTPUT
          fi

  deploy:
    needs: update-stats
    if: |
      (needs.update-stats.result == 'success' && needs.update-stats.outputs.stats_updated == 'true') ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: Verify dashboard files exist
        run: |
          echo "Checking dashboard files..."
          if [ -d "./dashboard" ]; then
            echo "Dashboard directory found"
            ls -la ./dashboard/
            if [ -z "$(ls -A ./dashboard/)" ]; then
              echo "Warning: Dashboard directory is empty"
              echo "<html><body><h1>Dashboard is being generated...</h1></body></html>" > ./dashboard/index.html
            fi
          else
            echo "Dashboard directory not found, creating with placeholder..."
            mkdir -p ./dashboard
            echo "<html><body><h1>Dashboard is being generated...</h1><p>Last update: $(date)</p></body></html>" > ./dashboard/index.html
          fi

      - name: Upload dashboard as artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # 上传dashboard目录到GitHub Pages
          path: "./dashboard"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
